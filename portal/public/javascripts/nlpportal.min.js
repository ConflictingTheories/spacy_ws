const portal_server="";const nlp_rest_server="http://ssh-001.kderbyma.com:8088/";const nlp_ws_server="ws://ssh-001.kderbyma.com:8765/";let redactionSubmission=[];let reportingSubmission=[];let redactionList=[];let reportingList=[];let ws=null;function connectToWS(listId){ws=new WebSocket(nlp_ws_server);ws.onopen=function(event){ws.send("Here's some text that the server is urgently awaiting translation!");ws.onmessage=function(event){let msg=event.data;displayTags(msg,listId);console.log(msg)}}}function sendMsg(textId){let msg=document.getElementById(textId).value;ws.send(msg)}function displayTags(msg,listId){let msgObj=JSON.parse(msg);let tags=Object.keys(msgObj);let list=document.getElementById(listId);list.innerHTML=tags.map(x=>{let tokens=msgObj[x];let output=[`<thead>${tags.map(x=>"<th>"+x+"</th>")}</thead>`,`<tbody>${tokens.map(y=>`<tr><td>${y}</td></tr></tbody>`)}`];return output.join("")}).join("")}function loadRow(button,textId){let newText=button.innerText;document.getElementById(textId).innerText=newText}function localCSV(inputId,tableId,textId){var dvCSV=document.getElementById(tableId);var fileUpload=document.getElementById(inputId);var regex=/^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;if(regex.test(fileUpload.value.toLowerCase())){if(typeof FileReader!="undefined"){var reader=new FileReader;reader.onload=function(e){dvCSV.innerHTML="";console.log("LOADED",e);var rows=e.target.result.split("\n");for(var i=0;i<rows.length;i++){var cells=rows[i].split(",");console.log("Cells,",cells);console.log("Rows",rows);if(cells.length>0){for(var j=0;j<cells.length;j++){var li=document.createElement("li");li.classList.add("collection-item");li.innerHTML=`<a style="text-overflow:ellipsis;white-space:nowrap;overflow:hidden;cursor:pointer;" onclick="loadRow(this,'${textId}')">${cells[j]}</a></div>`;dvCSV.appendChild(li)}}}};reader.readAsText(fileUpload.files[0])}else{alert("This browser does not support HTML5.")}}else{alert("Please upload a valid CSV file.")}}function remoteRemoteCSV(inputId,textId){let url=document.getElementById(inputId).value;$.ajaxPrefilter("script",function(options){options.crossDomain=true});$.ajax({type:"GET",url:url,dataType:"script",success:function(data){console.log(data)},error:function(request,status,error){console.error(error)}})}function clearSelection(){if(window.getSelection){if(window.getSelection().empty){window.getSelection().empty()}else if(window.getSelection().removeAllRanges){window.getSelection().removeAllRanges()}}else if(document.selection){document.selection.empty()}}function getSelectionText(textId){var text="";var start,end;text=window.getSelection();start=text.anchorOffset;end=text.focusOffset;return{text:text,start:start,end:end}}function getWordOnClick(textId){let text=document.getElementById(textId).innerText;let sele=window.getSelection();console.log(text);start=sele.anchorOffset;end=sele.focusOffset;console.log(sele,text,start,end);if(start==end&&text!=""){let foundWord=false;let foundStart=null;let foundEnd=null;let cnt=0;while(!foundWord&&cnt<100){if(foundStart===null&&start-cnt>0&&text[start-cnt]!==" "&&text[start-cnt]!=="\n"&&text[start+cnt]!==""){console.log(text[start-cnt])}else{if(foundStart===null){foundStart=start-cnt==0?start-cnt:start-cnt+1;console.log("START",foundStart)}}if(foundEnd===null&&end+cnt<text.length&&text[end+cnt]!==" "&&text[start+cnt]!=="\n"&&text[start+cnt]!==""){console.log(text[end+cnt])}else{if(foundEnd===null){foundEnd=end+cnt;console.log("END",foundEnd)}}if(foundStart!==null&&foundEnd!==null){console.log(foundStart,foundEnd,text.substring(foundStart,foundEnd));foundWord=true;let range=document.createRange();range.setEnd(sele.focusNode,foundEnd);range.setStart(sele.focusNode,foundStart);sele.removeAllRanges();sele.addRange(range)}else{console.log("searching .. ..");cnt++}}}}function addTagSel(tag,idelm){var tag_type=new Array("<",">");var txta=document.getElementById(idelm);var start=tag_type[0]+tag+tag_type[1];var end=tag_type[0]+"/"+tag+tag_type[1];var IE=false;if(IE){var r=document.selection.createRange();var tr=txta.createTextRange();var tr2=tr.duplicate();tr2.moveToBookmark(r.getBookmark());tr.setEndPoint("EndToStart",tr2);var tag_seltxt=start+r.text+end;var the_start=txta.value.replace(/[\r\n]/g,".").indexOf(r.text.replace(/[\r\n]/g,"."),tr.text.length);txta.value=txta.value.substring(0,the_start)+tag_seltxt+txta.value.substring(the_start+tag_seltxt.length,txta.value.length);var pos=txta.value.length-end.length;tr.collapse(true);tr.moveEnd("character",pos);tr.moveStart("character",pos);tr.select()}else if(txta.selectionStart||txta.selectionStart=="0"){var startPos=txta.selectionStart;var endPos=txta.selectionEnd;var tag_seltxt=start+txta.value.substring(startPos,endPos)+end;txta.value=txta.value.substring(0,startPos)+tag_seltxt+txta.value.substring(endPos,txta.value.length);txta.setSelectionRange(endPos+start.length,endPos+start.length);txta.focus()}return tag_seltxt}function redactSelection(type,listId,textId){let selectionText=getSelectionText(textId);if(selectionText.start!==selectionText.end){switch(type){case"people":redactionList.push([selectionText.start,selectionText.end,"PERSON"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'PERSON']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"racial":redactionList.push([selectionText.start,selectionText.end,"RACIAL"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'RACIAL']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"address":redactionList.push([selectionText.start,selectionText.end,"ADDRESS"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'ADDRESS']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"phone":redactionList.push([selectionText.start,selectionText.end,"PHONE"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'PHONE']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"email":redactionList.push([selectionText.start,selectionText.end,"EMAIL"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'EMAIL']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"title":redactionList.push([selectionText.start,selectionText.end,"TITLE"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'TITLE']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;default:Swal.fire({title:"Missing Information!",text:"Missing Type Information - Something appears to have gone wrong.",type:"error",confirmButtonText:"Got it, Thanks"}).then(res=>{console.log(res);clearSelection()})}}}function reportSelection(type,listId,textId){let selectionText=getSelectionText(textId);if(selectionText.start!==selectionText.end){switch(type){case"perpetrator":reportingList.push([selectionText.start,selectionText.end,"PERPETRATOR"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'PERPETRATOR']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"victim":reportingList.push([selectionText.start,selectionText.end,"VICTIM"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'VICTIM']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"location":reportingList.push([selectionText.start,selectionText.end,"LOCATION"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'LOCATION']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"time":reportingList.push([selectionText.start,selectionText.end,"TIME"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'TIME']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;case"weapon":reportingList.push([selectionText.start,selectionText.end,"WEAPON"]);if(listId){let dom=document.getElementById(listId).innerHTML;dom+=`<li class="collection-item">[${selectionText.start}, ${selectionText.end}, 'WEAPON']</li>`;document.getElementById(listId).innerHTML=dom}clearSelection();break;default:Swal.fire({title:"Missing Information!",text:"Missing Type Information - Something appears to have gone wrong.",type:"error",confirmButtonText:"Got it, Thanks"}).then(res=>{console.log(res)})}}}function clearRedactions(listId){redactionList=[];document.getElementById(listId).innerHTML=""}function clearReporting(listId){reportingList=[];document.getElementById(listId).innerHTML=""}function saveRedaction(textId,listId){let payload=[document.getElementById(textId).innerText,{entities:redactionList.map(x=>x)}];redactionSubmission.push(payload);clearRedactions(listId);console.log(redactionSubmission)}function saveReport(textId,listId){let payload=[document.getElementById(textId).innerText,{entities:reportingList.map(x=>x)}];reportingSubmission.push(payload);clearReporting(listId);console.log(reportingSubmission)}function uploadTraining(url,payload){$.ajax({type:"POST",url:`${portal_server}${url}`,dataType:"json",contentType:"application/json",data:JSON.stringify(payload),success:function(data){console.log(data)},error:function(request,status,error){console.error(error)}})}function refreshModel(type){$.ajax({type:"GET",url:`${portal_server}/api/retrain/${type}`,contentType:"application/json",success:function(data){console.log(data)},error:function(request,status,error){console.error(error)}})}function loadModel(textId){let type=document.getElementById(textId).value;$.ajax({type:"GET",url:`${portal_server}/api/reload/${type}`,contentType:"application/json",success:function(data){console.log(data)},error:function(request,status,error){console.error(error)}})}function exportJSON(){Swal.fire({title:"Finished Training?",text:"Confirm to submit.",type:"info",showCancelButton:true,cancelButtontext:"Go Back",confirmButtonText:"Got it, Thanks"}).then(res=>{console.log(res);if(res.value){if(reportingSubmission.length>0){uploadTraining("/api/train/report",reportingSubmission);var a=document.createElement("a");var file=new Blob([JSON.stringify(reportingSubmission)],{type:"application/json;charset=utf-8"});a.href=URL.createObjectURL(file);a.download="reportingData.json";a.click()}if(redactionSubmission.length>0){uploadTraining("/api/train/redact",redactionSubmission);var a=document.createElement("a");var file=new Blob([JSON.stringify(redactionSubmission)],{type:"application/json;charset=utf-8"});a.href=URL.createObjectURL(file);a.download="redactionData.json";a.click()}}})}
